%%

%%
clc, clear, close all

N = 64;

A = 5;
B = 1000;

% rng('default')

a = A*abs(rand(N,1));
b = B*abs(rand(N,1));

[~,amax] = max(a./b);

nu_max = a(amax)*(N^2) - b(amax);
nu_min = -min(b);
dnu= 0.01;

nu = nu_min:dnu:nu_max;

y = sqrt(a./(b+nu));

yf = sum(y,1);

plot(nu,yf)
hold on
yline(1)

%%
clc, clear, close all


all_params = initProblem();
rho_i = solve_rho_i(all_params.Ti_c(:,1), all_params.Bu, all_params.Pi*all_params.Giu/all_params.Pnu, 10, 10)
rho_i = solve_rho_i(di, Bu, SNR_i, c_t, c_Bu)


di = all_params.Ti_c(:,1);
Bu = all_params.Bu;
SNR_i = all_params.Pi*all_params.Giu/all_params.Pnu;
c_t = 10;
c_Bu = 10;


%%
clc, clear, close all

all_params = initProblem();
di = all_params.Ti_c(:,1);
Bu = all_params.Bu;
SNR_i = all_params.Pi*all_params.Giu'/all_params.Pnu;
c_t = 10000;
c_Bu = 0.001;

    ai      = (c_t*di/Bu).*(1./log2(1+SNR_i));    % Delay cost per unit bandwidth
    bi      = c_Bu*Bu;                  % Bandwidth cost per unit bandwidth
    
    I = length(di);

    % Check if optimal values are jointly feasible

    rho_opt_i = sum(sqrt(ai./bi));

    if rho_opt_i<=1
        rho_i = rho_opt_i;
        return;
    end

    % Bisection algorithm
    
    [~,amax] = max(ai./bi);
    nu_max = ai(amax)*(I^2) - bi;
    nu_min = 0;

    % Check maximum feasibility
    while 1
        if bi + nu_max <=0
            nu_min = -bi;
            nu_max = 0;
        end
        rho_max = sqrt(ai(amax)./( bi + nu_max ));

        if rho_max <1
            break;
        else
            nu_min = nu_max;
            nu_max = nu_max*2;
        end
        fprintf('Loop1\t rho_max = %f \t nu_max = %f\n', rho_max, nu_max)
        pause
    end

    % Start bisection loop
    Nn = 30;
    for nn=1:Nn
        nu = (nu_min + nu_max)/2;
        rho_bis_i = sum(sqrt(ai./(bi + nu)));
        if rho_bis_i < 1
            nu_max = nu;
        else
            nu_min = nu;
        end
        fprintf('Loop2\n')
    end
